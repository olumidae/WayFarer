"use strict";

var cov_o2sq5k6we = function () {
  var path = "C:\\Users\\TENIOLA\\Documents\\Projects\\WayFarer\\server\\controllers\\bookController.js";
  var hash = "4573781db02231a3591c738ce60bee6665297d23";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "C:\\Users\\TENIOLA\\Documents\\Projects\\WayFarer\\server\\controllers\\bookController.js",
    statementMap: {
      "0": {
        start: {
          line: 4,
          column: 13
        },
        end: {
          line: 233,
          column: 1
        }
      },
      "1": {
        start: {
          line: 6,
          column: 4
        },
        end: {
          line: 60,
          column: 5
        }
      },
      "2": {
        start: {
          line: 7,
          column: 28
        },
        end: {
          line: 7,
          column: 36
        }
      },
      "3": {
        start: {
          line: 8,
          column: 26
        },
        end: {
          line: 8,
          column: 34
        }
      },
      "4": {
        start: {
          line: 9,
          column: 28
        },
        end: {
          line: 9,
          column: 36
        }
      },
      "5": {
        start: {
          line: 10,
          column: 6
        },
        end: {
          line: 12,
          column: 7
        }
      },
      "6": {
        start: {
          line: 11,
          column: 8
        },
        end: {
          line: 11,
          column: 57
        }
      },
      "7": {
        start: {
          line: 13,
          column: 24
        },
        end: {
          line: 13,
          column: 62
        }
      },
      "8": {
        start: {
          line: 14,
          column: 23
        },
        end: {
          line: 14,
          column: 59
        }
      },
      "9": {
        start: {
          line: 16,
          column: 6
        },
        end: {
          line: 16,
          column: 83
        }
      },
      "10": {
        start: {
          line: 16,
          column: 20
        },
        end: {
          line: 16,
          column: 83
        }
      },
      "11": {
        start: {
          line: 17,
          column: 6
        },
        end: {
          line: 17,
          column: 126
        }
      },
      "12": {
        start: {
          line: 17,
          column: 41
        },
        end: {
          line: 17,
          column: 126
        }
      },
      "13": {
        start: {
          line: 19,
          column: 21
        },
        end: {
          line: 19,
          column: 29
        }
      },
      "14": {
        start: {
          line: 20,
          column: 24
        },
        end: {
          line: 23,
          column: 7
        }
      },
      "15": {
        start: {
          line: 24,
          column: 29
        },
        end: {
          line: 24,
          column: 56
        }
      },
      "16": {
        start: {
          line: 25,
          column: 6
        },
        end: {
          line: 30,
          column: 7
        }
      },
      "17": {
        start: {
          line: 26,
          column: 8
        },
        end: {
          line: 29,
          column: 11
        }
      },
      "18": {
        start: {
          line: 32,
          column: 24
        },
        end: {
          line: 35,
          column: 7
        }
      },
      "19": {
        start: {
          line: 36,
          column: 29
        },
        end: {
          line: 36,
          column: 56
        }
      },
      "20": {
        start: {
          line: 37,
          column: 6
        },
        end: {
          line: 37,
          column: 100
        }
      },
      "21": {
        start: {
          line: 37,
          column: 19
        },
        end: {
          line: 37,
          column: 100
        }
      },
      "22": {
        start: {
          line: 39,
          column: 26
        },
        end: {
          line: 42,
          column: 7
        }
      },
      "23": {
        start: {
          line: 43,
          column: 32
        },
        end: {
          line: 43,
          column: 61
        }
      },
      "24": {
        start: {
          line: 44,
          column: 6
        },
        end: {
          line: 57,
          column: 9
        }
      },
      "25": {
        start: {
          line: 59,
          column: 6
        },
        end: {
          line: 59,
          column: 83
        }
      },
      "26": {
        start: {
          line: 64,
          column: 4
        },
        end: {
          line: 110,
          column: 5
        }
      },
      "27": {
        start: {
          line: 65,
          column: 31
        },
        end: {
          line: 65,
          column: 39
        }
      },
      "28": {
        start: {
          line: 66,
          column: 6
        },
        end: {
          line: 85,
          column: 7
        }
      },
      "29": {
        start: {
          line: 67,
          column: 30
        },
        end: {
          line: 73,
          column: 9
        }
      },
      "30": {
        start: {
          line: 74,
          column: 25
        },
        end: {
          line: 74,
          column: 56
        }
      },
      "31": {
        start: {
          line: 75,
          column: 8
        },
        end: {
          line: 80,
          column: 9
        }
      },
      "32": {
        start: {
          line: 76,
          column: 10
        },
        end: {
          line: 79,
          column: 13
        }
      },
      "33": {
        start: {
          line: 81,
          column: 8
        },
        end: {
          line: 84,
          column: 11
        }
      },
      "34": {
        start: {
          line: 86,
          column: 28
        },
        end: {
          line: 93,
          column: 7
        }
      },
      "35": {
        start: {
          line: 94,
          column: 23
        },
        end: {
          line: 94,
          column: 54
        }
      },
      "36": {
        start: {
          line: 95,
          column: 6
        },
        end: {
          line: 100,
          column: 7
        }
      },
      "37": {
        start: {
          line: 96,
          column: 8
        },
        end: {
          line: 99,
          column: 11
        }
      },
      "38": {
        start: {
          line: 101,
          column: 6
        },
        end: {
          line: 104,
          column: 9
        }
      },
      "39": {
        start: {
          line: 106,
          column: 6
        },
        end: {
          line: 109,
          column: 9
        }
      },
      "40": {
        start: {
          line: 114,
          column: 4
        },
        end: {
          line: 145,
          column: 5
        }
      },
      "41": {
        start: {
          line: 115,
          column: 28
        },
        end: {
          line: 115,
          column: 38
        }
      },
      "42": {
        start: {
          line: 117,
          column: 21
        },
        end: {
          line: 117,
          column: 29
        }
      },
      "43": {
        start: {
          line: 118,
          column: 27
        },
        end: {
          line: 121,
          column: 7
        }
      },
      "44": {
        start: {
          line: 122,
          column: 23
        },
        end: {
          line: 122,
          column: 53
        }
      },
      "45": {
        start: {
          line: 123,
          column: 6
        },
        end: {
          line: 128,
          column: 7
        }
      },
      "46": {
        start: {
          line: 124,
          column: 8
        },
        end: {
          line: 127,
          column: 11
        }
      },
      "47": {
        start: {
          line: 129,
          column: 28
        },
        end: {
          line: 132,
          column: 7
        }
      },
      "48": {
        start: {
          line: 133,
          column: 6
        },
        end: {
          line: 133,
          column: 38
        }
      },
      "49": {
        start: {
          line: 134,
          column: 6
        },
        end: {
          line: 139,
          column: 9
        }
      },
      "50": {
        start: {
          line: 141,
          column: 6
        },
        end: {
          line: 144,
          column: 9
        }
      },
      "51": {
        start: {
          line: 149,
          column: 4
        },
        end: {
          line: 178,
          column: 5
        }
      },
      "52": {
        start: {
          line: 150,
          column: 25
        },
        end: {
          line: 150,
          column: 35
        }
      },
      "53": {
        start: {
          line: 151,
          column: 24
        },
        end: {
          line: 154,
          column: 7
        }
      },
      "54": {
        start: {
          line: 155,
          column: 23
        },
        end: {
          line: 155,
          column: 50
        }
      },
      "55": {
        start: {
          line: 156,
          column: 6
        },
        end: {
          line: 161,
          column: 7
        }
      },
      "56": {
        start: {
          line: 157,
          column: 8
        },
        end: {
          line: 160,
          column: 11
        }
      },
      "57": {
        start: {
          line: 162,
          column: 25
        },
        end: {
          line: 165,
          column: 7
        }
      },
      "58": {
        start: {
          line: 166,
          column: 6
        },
        end: {
          line: 166,
          column: 35
        }
      },
      "59": {
        start: {
          line: 167,
          column: 6
        },
        end: {
          line: 172,
          column: 9
        }
      },
      "60": {
        start: {
          line: 174,
          column: 6
        },
        end: {
          line: 177,
          column: 9
        }
      },
      "61": {
        start: {
          line: 182,
          column: 4
        },
        end: {
          line: 230,
          column: 5
        }
      },
      "62": {
        start: {
          line: 183,
          column: 37
        },
        end: {
          line: 183,
          column: 45
        }
      },
      "63": {
        start: {
          line: 184,
          column: 28
        },
        end: {
          line: 184,
          column: 38
        }
      },
      "64": {
        start: {
          line: 185,
          column: 30
        },
        end: {
          line: 185,
          column: 38
        }
      },
      "65": {
        start: {
          line: 187,
          column: 27
        },
        end: {
          line: 190,
          column: 7
        }
      },
      "66": {
        start: {
          line: 191,
          column: 23
        },
        end: {
          line: 191,
          column: 53
        }
      },
      "67": {
        start: {
          line: 192,
          column: 6
        },
        end: {
          line: 197,
          column: 7
        }
      },
      "68": {
        start: {
          line: 193,
          column: 8
        },
        end: {
          line: 196,
          column: 11
        }
      },
      "69": {
        start: {
          line: 198,
          column: 26
        },
        end: {
          line: 201,
          column: 7
        }
      },
      "70": {
        start: {
          line: 202,
          column: 30
        },
        end: {
          line: 202,
          column: 59
        }
      },
      "71": {
        start: {
          line: 203,
          column: 6
        },
        end: {
          line: 208,
          column: 7
        }
      },
      "72": {
        start: {
          line: 204,
          column: 8
        },
        end: {
          line: 207,
          column: 11
        }
      },
      "73": {
        start: {
          line: 210,
          column: 25
        },
        end: {
          line: 213,
          column: 7
        }
      },
      "74": {
        start: {
          line: 214,
          column: 32
        },
        end: {
          line: 214,
          column: 60
        }
      },
      "75": {
        start: {
          line: 215,
          column: 6
        },
        end: {
          line: 224,
          column: 9
        }
      },
      "76": {
        start: {
          line: 226,
          column: 6
        },
        end: {
          line: 229,
          column: 9
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 5,
            column: 2
          },
          end: {
            line: 5,
            column: 3
          }
        },
        loc: {
          start: {
            line: 5,
            column: 30
          },
          end: {
            line: 61,
            column: 3
          }
        },
        line: 5
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 63,
            column: 2
          },
          end: {
            line: 63,
            column: 3
          }
        },
        loc: {
          start: {
            line: 63,
            column: 30
          },
          end: {
            line: 111,
            column: 3
          }
        },
        line: 63
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 113,
            column: 2
          },
          end: {
            line: 113,
            column: 3
          }
        },
        loc: {
          start: {
            line: 113,
            column: 32
          },
          end: {
            line: 146,
            column: 3
          }
        },
        line: 113
      },
      "3": {
        name: "(anonymous_3)",
        decl: {
          start: {
            line: 148,
            column: 2
          },
          end: {
            line: 148,
            column: 3
          }
        },
        loc: {
          start: {
            line: 148,
            column: 29
          },
          end: {
            line: 179,
            column: 3
          }
        },
        line: 148
      },
      "4": {
        name: "(anonymous_4)",
        decl: {
          start: {
            line: 181,
            column: 2
          },
          end: {
            line: 181,
            column: 3
          }
        },
        loc: {
          start: {
            line: 181,
            column: 30
          },
          end: {
            line: 231,
            column: 3
          }
        },
        line: 181
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 10,
            column: 6
          },
          end: {
            line: 12,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 10,
            column: 6
          },
          end: {
            line: 12,
            column: 7
          }
        }, {
          start: {
            line: 10,
            column: 6
          },
          end: {
            line: 12,
            column: 7
          }
        }],
        line: 10
      },
      "1": {
        loc: {
          start: {
            line: 16,
            column: 6
          },
          end: {
            line: 16,
            column: 83
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 16,
            column: 6
          },
          end: {
            line: 16,
            column: 83
          }
        }, {
          start: {
            line: 16,
            column: 6
          },
          end: {
            line: 16,
            column: 83
          }
        }],
        line: 16
      },
      "2": {
        loc: {
          start: {
            line: 17,
            column: 6
          },
          end: {
            line: 17,
            column: 126
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 17,
            column: 6
          },
          end: {
            line: 17,
            column: 126
          }
        }, {
          start: {
            line: 17,
            column: 6
          },
          end: {
            line: 17,
            column: 126
          }
        }],
        line: 17
      },
      "3": {
        loc: {
          start: {
            line: 25,
            column: 6
          },
          end: {
            line: 30,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 25,
            column: 6
          },
          end: {
            line: 30,
            column: 7
          }
        }, {
          start: {
            line: 25,
            column: 6
          },
          end: {
            line: 30,
            column: 7
          }
        }],
        line: 25
      },
      "4": {
        loc: {
          start: {
            line: 37,
            column: 6
          },
          end: {
            line: 37,
            column: 100
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 37,
            column: 6
          },
          end: {
            line: 37,
            column: 100
          }
        }, {
          start: {
            line: 37,
            column: 6
          },
          end: {
            line: 37,
            column: 100
          }
        }],
        line: 37
      },
      "5": {
        loc: {
          start: {
            line: 66,
            column: 6
          },
          end: {
            line: 85,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 66,
            column: 6
          },
          end: {
            line: 85,
            column: 7
          }
        }, {
          start: {
            line: 66,
            column: 6
          },
          end: {
            line: 85,
            column: 7
          }
        }],
        line: 66
      },
      "6": {
        loc: {
          start: {
            line: 75,
            column: 8
          },
          end: {
            line: 80,
            column: 9
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 75,
            column: 8
          },
          end: {
            line: 80,
            column: 9
          }
        }, {
          start: {
            line: 75,
            column: 8
          },
          end: {
            line: 80,
            column: 9
          }
        }],
        line: 75
      },
      "7": {
        loc: {
          start: {
            line: 95,
            column: 6
          },
          end: {
            line: 100,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 95,
            column: 6
          },
          end: {
            line: 100,
            column: 7
          }
        }, {
          start: {
            line: 95,
            column: 6
          },
          end: {
            line: 100,
            column: 7
          }
        }],
        line: 95
      },
      "8": {
        loc: {
          start: {
            line: 123,
            column: 6
          },
          end: {
            line: 128,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 123,
            column: 6
          },
          end: {
            line: 128,
            column: 7
          }
        }, {
          start: {
            line: 123,
            column: 6
          },
          end: {
            line: 128,
            column: 7
          }
        }],
        line: 123
      },
      "9": {
        loc: {
          start: {
            line: 156,
            column: 6
          },
          end: {
            line: 161,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 156,
            column: 6
          },
          end: {
            line: 161,
            column: 7
          }
        }, {
          start: {
            line: 156,
            column: 6
          },
          end: {
            line: 161,
            column: 7
          }
        }],
        line: 156
      },
      "10": {
        loc: {
          start: {
            line: 192,
            column: 6
          },
          end: {
            line: 197,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 192,
            column: 6
          },
          end: {
            line: 197,
            column: 7
          }
        }, {
          start: {
            line: 192,
            column: 6
          },
          end: {
            line: 197,
            column: 7
          }
        }],
        line: 192
      },
      "11": {
        loc: {
          start: {
            line: 203,
            column: 6
          },
          end: {
            line: 208,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 203,
            column: 6
          },
          end: {
            line: 208,
            column: 7
          }
        }, {
          start: {
            line: 203,
            column: 6
          },
          end: {
            line: 208,
            column: 7
          }
        }],
        line: 203
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0,
      "22": 0,
      "23": 0,
      "24": 0,
      "25": 0,
      "26": 0,
      "27": 0,
      "28": 0,
      "29": 0,
      "30": 0,
      "31": 0,
      "32": 0,
      "33": 0,
      "34": 0,
      "35": 0,
      "36": 0,
      "37": 0,
      "38": 0,
      "39": 0,
      "40": 0,
      "41": 0,
      "42": 0,
      "43": 0,
      "44": 0,
      "45": 0,
      "46": 0,
      "47": 0,
      "48": 0,
      "49": 0,
      "50": 0,
      "51": 0,
      "52": 0,
      "53": 0,
      "54": 0,
      "55": 0,
      "56": 0,
      "57": 0,
      "58": 0,
      "59": 0,
      "60": 0,
      "61": 0,
      "62": 0,
      "63": 0,
      "64": 0,
      "65": 0,
      "66": 0,
      "67": 0,
      "68": 0,
      "69": 0,
      "70": 0,
      "71": 0,
      "72": 0,
      "73": 0,
      "74": 0,
      "75": 0,
      "76": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0],
      "2": [0, 0],
      "3": [0, 0],
      "4": [0, 0],
      "5": [0, 0],
      "6": [0, 0],
      "7": [0, 0],
      "8": [0, 0],
      "9": [0, 0],
      "10": [0, 0],
      "11": [0, 0]
    },
    _coverageSchema: "43e27e138ebf9cfc5966b082cf9a028302ed4184",
    hash: "4573781db02231a3591c738ce60bee6665297d23"
  };
  var coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _db = _interopRequireDefault(require("../models/db/db"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var Book = (cov_o2sq5k6we.s[0]++, {
  makeBooking: function () {
    var _makeBooking = _asyncToGenerator(
    /*#__PURE__*/
    regeneratorRuntime.mark(function _callee(req, res) {
      var _ref, email, id, _ref2, trip_id, _ref3, seat_number, checkUser, _ref4, rows, status, checkTrip, _ref5, trip, checkSeat, _ref6, seat, createQuery, _ref7, booking;

      return regeneratorRuntime.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              cov_o2sq5k6we.f[0]++;
              cov_o2sq5k6we.s[1]++;
              _context.prev = 2;
              _ref = (cov_o2sq5k6we.s[2]++, req.user), email = _ref.email, id = _ref.id;
              _ref2 = (cov_o2sq5k6we.s[3]++, req.body), trip_id = _ref2.trip_id;
              _ref3 = (cov_o2sq5k6we.s[4]++, req.body), seat_number = _ref3.seat_number;
              cov_o2sq5k6we.s[5]++;

              if (!seat_number) {
                cov_o2sq5k6we.b[0][0]++;
                cov_o2sq5k6we.s[6]++;
                seat_number = Math.floor(Math.random() * 18) + 1;
              } else {
                cov_o2sq5k6we.b[0][1]++;
              }

              checkUser = (cov_o2sq5k6we.s[7]++, 'SELECT * FROM users WHERE email = $1');
              cov_o2sq5k6we.s[8]++;
              _context.next = 12;
              return _db["default"].query(checkUser, [email]);

            case 12:
              _ref4 = _context.sent;
              rows = _ref4.rows;
              cov_o2sq5k6we.s[9]++;

              if (!rows[0]) {
                cov_o2sq5k6we.b[1][0]++;
                cov_o2sq5k6we.s[10]++;
                res.status(401).json({
                  status: 401,
                  error: 'Please sign up'
                });
              } else {
                cov_o2sq5k6we.b[1][1]++;
              }

              cov_o2sq5k6we.s[11]++;

              if (rows[0].is_loggedin === false) {
                cov_o2sq5k6we.b[2][0]++;
                cov_o2sq5k6we.s[12]++;
                res.status(401).json({
                  status: 401,
                  error: 'You must be logged in to book a trip'
                });
              } else {
                cov_o2sq5k6we.b[2][1]++;
              }

              status = (cov_o2sq5k6we.s[13]++, 'active');
              checkTrip = (cov_o2sq5k6we.s[14]++, {
                text: 'SELECT * FROM trip where id = $1 AND status = $2',
                values: [trip_id, status]
              });
              cov_o2sq5k6we.s[15]++;
              _context.next = 23;
              return _db["default"].query(checkTrip);

            case 23:
              _ref5 = _context.sent;
              trip = _ref5.rows;
              cov_o2sq5k6we.s[16]++;

              if (trip[0]) {
                _context.next = 32;
                break;
              }

              cov_o2sq5k6we.b[3][0]++;
              cov_o2sq5k6we.s[17]++;
              return _context.abrupt("return", res.status(404).json({
                status: 404,
                error: 'trip not available'
              }));

            case 32:
              cov_o2sq5k6we.b[3][1]++;

            case 33:
              checkSeat = (cov_o2sq5k6we.s[18]++, {
                text: 'SELECT * FROM booking where trip_id = $1 AND seat_number = $2',
                values: [trip_id, seat_number]
              });
              cov_o2sq5k6we.s[19]++;
              _context.next = 37;
              return _db["default"].query(checkSeat);

            case 37:
              _ref6 = _context.sent;
              seat = _ref6.rows;
              cov_o2sq5k6we.s[20]++;

              if (!seat[0]) {
                _context.next = 46;
                break;
              }

              cov_o2sq5k6we.b[4][0]++;
              cov_o2sq5k6we.s[21]++;
              return _context.abrupt("return", res.status(409).json({
                status: 409,
                error: 'Seat number already taken'
              }));

            case 46:
              cov_o2sq5k6we.b[4][1]++;

            case 47:
              createQuery = (cov_o2sq5k6we.s[22]++, {
                text: 'INSERT INTO booking(trip_id, user_id, seat_number) VALUES($1, $2, $3) RETURNING *',
                values: [trip_id, id, seat_number]
              });
              cov_o2sq5k6we.s[23]++;
              _context.next = 51;
              return _db["default"].query(createQuery);

            case 51:
              _ref7 = _context.sent;
              booking = _ref7.rows;
              cov_o2sq5k6we.s[24]++;
              return _context.abrupt("return", res.status(201).json({
                status: 'success',
                data: {
                  id: booking[0].id,
                  user_id: rows[0].user_id,
                  trip_id: trip[0].id,
                  bus_id: trip[0].bus_id,
                  trip_date: trip[0].trip_date,
                  seat_number: booking[0].seat_number,
                  first_name: rows[0].first_name,
                  last_name: rows[0].last_name,
                  email: rows[0].email
                }
              }));

            case 57:
              _context.prev = 57;
              _context.t0 = _context["catch"](2);
              cov_o2sq5k6we.s[25]++;
              return _context.abrupt("return", res.status(500).json({
                status: 500,
                error: 'Internal server error'
              }));

            case 61:
            case "end":
              return _context.stop();
          }
        }
      }, _callee, null, [[2, 57]]);
    }));

    function makeBooking(_x, _x2) {
      return _makeBooking.apply(this, arguments);
    }

    return makeBooking;
  }(),
  getbookings: function () {
    var _getbookings = _asyncToGenerator(
    /*#__PURE__*/
    regeneratorRuntime.mark(function _callee2(req, res) {
      var _ref8, is_admin, id, _checkBookings, _ref9, _rows, checkBookings, _ref10, rows;

      return regeneratorRuntime.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              cov_o2sq5k6we.f[1]++;
              cov_o2sq5k6we.s[26]++;
              _context2.prev = 2;
              _ref8 = (cov_o2sq5k6we.s[27]++, req.user), is_admin = _ref8.is_admin, id = _ref8.id;
              cov_o2sq5k6we.s[28]++;

              if (!(is_admin === Boolean(true))) {
                _context2.next = 25;
                break;
              }

              cov_o2sq5k6we.b[5][0]++;
              _checkBookings = (cov_o2sq5k6we.s[29]++, {
                text: "SELECT \n        booking.id AS booking_id,booking.user_id, booking.seat_number, booking.trip_id, \n        trip.bus_id, trip.origin, trip.destination, trip.trip_date, trip.status,\n        users.first_name, users.last_name, users.email\n        FROM booking JOIN trip ON (booking.trip_id = trip.id) JOIN users ON (booking.user_id = users.id)"
              });
              cov_o2sq5k6we.s[30]++;
              _context2.next = 11;
              return _db["default"].query(_checkBookings);

            case 11:
              _ref9 = _context2.sent;
              _rows = _ref9.rows;
              cov_o2sq5k6we.s[31]++;

              if (_rows[0]) {
                _context2.next = 20;
                break;
              }

              cov_o2sq5k6we.b[6][0]++;
              cov_o2sq5k6we.s[32]++;
              return _context2.abrupt("return", res.status(404).json({
                status: 404,
                error: 'No booking found'
              }));

            case 20:
              cov_o2sq5k6we.b[6][1]++;

            case 21:
              cov_o2sq5k6we.s[33]++;
              return _context2.abrupt("return", res.status(200).json({
                status: 'success',
                data: _rows
              }));

            case 25:
              cov_o2sq5k6we.b[5][1]++;

            case 26:
              checkBookings = (cov_o2sq5k6we.s[34]++, {
                text: "SELECT \n      booking.id AS booking_id,booking.user_id, booking.seat_number, booking.trip_id, \n      trip.bus_id, trip.origin, trip.destination, trip.trip_date, trip.status,\n      users.first_name, users.last_name, users.email\n      FROM booking JOIN trip ON (booking.trip_id = trip.id) JOIN users ON (booking.user_id = users.id) WHERE user_id = $1",
                values: [id]
              });
              cov_o2sq5k6we.s[35]++;
              _context2.next = 30;
              return _db["default"].query(checkBookings);

            case 30:
              _ref10 = _context2.sent;
              rows = _ref10.rows;
              cov_o2sq5k6we.s[36]++;

              if (rows[0]) {
                _context2.next = 39;
                break;
              }

              cov_o2sq5k6we.b[7][0]++;
              cov_o2sq5k6we.s[37]++;
              return _context2.abrupt("return", res.status(404).json({
                status: 404,
                error: 'No booking found'
              }));

            case 39:
              cov_o2sq5k6we.b[7][1]++;

            case 40:
              cov_o2sq5k6we.s[38]++;
              return _context2.abrupt("return", res.status(200).json({
                status: 'success',
                data: rows
              }));

            case 44:
              _context2.prev = 44;
              _context2.t0 = _context2["catch"](2);
              cov_o2sq5k6we.s[39]++;
              return _context2.abrupt("return", res.status(500).json({
                status: 500,
                error: "Internal server error ".concat(_context2.t0.message)
              }));

            case 48:
            case "end":
              return _context2.stop();
          }
        }
      }, _callee2, null, [[2, 44]]);
    }));

    function getbookings(_x3, _x4) {
      return _getbookings.apply(this, arguments);
    }

    return getbookings;
  }(),
  deleteBooking: function () {
    var _deleteBooking = _asyncToGenerator(
    /*#__PURE__*/
    regeneratorRuntime.mark(function _callee3(req, res) {
      var _ref11, bookingId, _ref12, id, checkBooking, _ref13, rows, _deleteBooking2;

      return regeneratorRuntime.wrap(function _callee3$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              cov_o2sq5k6we.f[2]++;
              cov_o2sq5k6we.s[40]++;
              _context3.prev = 2;
              _ref11 = (cov_o2sq5k6we.s[41]++, req.params), bookingId = _ref11.bookingId;
              _ref12 = (cov_o2sq5k6we.s[42]++, req.user), id = _ref12.id;
              checkBooking = (cov_o2sq5k6we.s[43]++, {
                text: 'SELECT * FROM booking where id = $1 AND user_id = $2',
                values: [bookingId, id]
              });
              cov_o2sq5k6we.s[44]++;
              _context3.next = 9;
              return _db["default"].query(checkBooking);

            case 9:
              _ref13 = _context3.sent;
              rows = _ref13.rows;
              cov_o2sq5k6we.s[45]++;

              if (rows[0]) {
                _context3.next = 18;
                break;
              }

              cov_o2sq5k6we.b[8][0]++;
              cov_o2sq5k6we.s[46]++;
              return _context3.abrupt("return", res.status(400).json({
                status: 400,
                error: 'No booking found'
              }));

            case 18:
              cov_o2sq5k6we.b[8][1]++;

            case 19:
              _deleteBooking2 = (cov_o2sq5k6we.s[47]++, {
                text: 'DELETE FROM booking WHERE id = $1 AND user_id = $2',
                values: [bookingId, id]
              });
              cov_o2sq5k6we.s[48]++;
              _context3.next = 23;
              return _db["default"].query(_deleteBooking2);

            case 23:
              cov_o2sq5k6we.s[49]++;
              return _context3.abrupt("return", res.status(200).json({
                status: 'success',
                data: {
                  message: 'booking successfully deleted'
                }
              }));

            case 27:
              _context3.prev = 27;
              _context3.t0 = _context3["catch"](2);
              cov_o2sq5k6we.s[50]++;
              return _context3.abrupt("return", res.status(500).json({
                status: 500,
                error: "Internal server error ".concat(_context3.t0.message)
              }));

            case 31:
            case "end":
              return _context3.stop();
          }
        }
      }, _callee3, null, [[2, 27]]);
    }));

    function deleteBooking(_x5, _x6) {
      return _deleteBooking.apply(this, arguments);
    }

    return deleteBooking;
  }(),
  cancelTrip: function () {
    var _cancelTrip = _asyncToGenerator(
    /*#__PURE__*/
    regeneratorRuntime.mark(function _callee4(req, res) {
      var _ref14, tripId, checkTrip, _ref15, rows, updateTrip;

      return regeneratorRuntime.wrap(function _callee4$(_context4) {
        while (1) {
          switch (_context4.prev = _context4.next) {
            case 0:
              cov_o2sq5k6we.f[3]++;
              cov_o2sq5k6we.s[51]++;
              _context4.prev = 2;
              _ref14 = (cov_o2sq5k6we.s[52]++, req.params), tripId = _ref14.tripId;
              checkTrip = (cov_o2sq5k6we.s[53]++, {
                text: 'SELECT * FROM trips WHERE id = $1 and status = $2',
                values: [tripId, 'active']
              });
              cov_o2sq5k6we.s[54]++;
              _context4.next = 8;
              return _db["default"].query(checkTrip);

            case 8:
              _ref15 = _context4.sent;
              rows = _ref15.rows;
              cov_o2sq5k6we.s[55]++;

              if (rows[0]) {
                _context4.next = 17;
                break;
              }

              cov_o2sq5k6we.b[9][0]++;
              cov_o2sq5k6we.s[56]++;
              return _context4.abrupt("return", res.status(400).json({
                status: 400,
                error: 'Not an active trip'
              }));

            case 17:
              cov_o2sq5k6we.b[9][1]++;

            case 18:
              updateTrip = (cov_o2sq5k6we.s[57]++, {
                text: "UPDATE trips SET status = 'cancelled' WHERE id = $1",
                values: [tripId]
              });
              cov_o2sq5k6we.s[58]++;
              _context4.next = 22;
              return _db["default"].query(updateTrip);

            case 22:
              cov_o2sq5k6we.s[59]++;
              return _context4.abrupt("return", res.status(200).json({
                status: 'success',
                data: {
                  message: 'Trip cancelled successfully'
                }
              }));

            case 26:
              _context4.prev = 26;
              _context4.t0 = _context4["catch"](2);
              cov_o2sq5k6we.s[60]++;
              return _context4.abrupt("return", res.status(500).json({
                status: 500,
                error: "Internal server error ".concat(_context4.t0.message)
              }));

            case 30:
            case "end":
              return _context4.stop();
          }
        }
      }, _callee4, null, [[2, 26]]);
    }));

    function cancelTrip(_x7, _x8) {
      return _cancelTrip.apply(this, arguments);
    }

    return cancelTrip;
  }(),
  changeSeats: function () {
    var _changeSeats = _asyncToGenerator(
    /*#__PURE__*/
    regeneratorRuntime.mark(function _callee5(req, res) {
      var _ref16, email, user_id, _ref17, bookingId, _ref18, seat_number, checkBooking, _ref19, rows, checknumber, _ref20, seats, changeSeat, _ref21, changed;

      return regeneratorRuntime.wrap(function _callee5$(_context5) {
        while (1) {
          switch (_context5.prev = _context5.next) {
            case 0:
              cov_o2sq5k6we.f[4]++;
              cov_o2sq5k6we.s[61]++;
              _context5.prev = 2;
              _ref16 = (cov_o2sq5k6we.s[62]++, req.user), email = _ref16.email, user_id = _ref16.id;
              _ref17 = (cov_o2sq5k6we.s[63]++, req.params), bookingId = _ref17.bookingId;
              _ref18 = (cov_o2sq5k6we.s[64]++, req.body), seat_number = _ref18.seat_number;
              checkBooking = (cov_o2sq5k6we.s[65]++, {
                text: 'SELECT * FROM booking where id = $1 AND user_id = $2',
                values: [bookingId, user_id]
              });
              cov_o2sq5k6we.s[66]++;
              _context5.next = 10;
              return _db["default"].query(checkBooking);

            case 10:
              _ref19 = _context5.sent;
              rows = _ref19.rows;
              cov_o2sq5k6we.s[67]++;

              if (rows[0]) {
                _context5.next = 19;
                break;
              }

              cov_o2sq5k6we.b[10][0]++;
              cov_o2sq5k6we.s[68]++;
              return _context5.abrupt("return", res.status(404).json({
                status: 404,
                error: 'No booking found'
              }));

            case 19:
              cov_o2sq5k6we.b[10][1]++;

            case 20:
              checknumber = (cov_o2sq5k6we.s[69]++, {
                text: 'SELECT * FROM booking where trip_id = $1  AND seat_number = $2',
                values: [rows[0].trip_id, seat_number]
              });
              cov_o2sq5k6we.s[70]++;
              _context5.next = 24;
              return _db["default"].query(checknumber);

            case 24:
              _ref20 = _context5.sent;
              seats = _ref20.rows;
              cov_o2sq5k6we.s[71]++;

              if (!seats[0]) {
                _context5.next = 33;
                break;
              }

              cov_o2sq5k6we.b[11][0]++;
              cov_o2sq5k6we.s[72]++;
              return _context5.abrupt("return", res.status(401).json({
                status: 401,
                error: 'seat already taken'
              }));

            case 33:
              cov_o2sq5k6we.b[11][1]++;

            case 34:
              changeSeat = (cov_o2sq5k6we.s[73]++, {
                text: 'UPDATE booking SET seat_number = $1 WHERE id = $2 RETURNING *',
                values: [seat_number, bookingId]
              });
              cov_o2sq5k6we.s[74]++;
              _context5.next = 38;
              return _db["default"].query(changeSeat);

            case 38:
              _ref21 = _context5.sent;
              changed = _ref21.rows;
              cov_o2sq5k6we.s[75]++;
              return _context5.abrupt("return", res.status(201).json({
                status: 'success',
                data: {
                  bookingId: bookingId,
                  user_id: user_id,
                  trip_id: changed[0].trip_id,
                  seat_number: seat_number,
                  email: email
                }
              }));

            case 44:
              _context5.prev = 44;
              _context5.t0 = _context5["catch"](2);
              cov_o2sq5k6we.s[76]++;
              return _context5.abrupt("return", res.status(500).json({
                status: 500,
                error: "Internal server error ".concat(_context5.t0.message)
              }));

            case 48:
            case "end":
              return _context5.stop();
          }
        }
      }, _callee5, null, [[2, 44]]);
    }));

    function changeSeats(_x9, _x10) {
      return _changeSeats.apply(this, arguments);
    }

    return changeSeats;
  }()
});
var _default = Book;
exports["default"] = _default;
//# sourceMappingURL=bookController.js.map